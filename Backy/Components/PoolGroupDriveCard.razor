<!-- Backy/Components/PoolGroupDriveCard.razor -->

<div class="card drive-card mb-3">
    <!-- Card Header -->
    <div class="card-header d-flex justify-content-between align-items-center">
        <div class="container">
            <div class="row">
                <!-- Left Section: Toggle Button, Drive Icon, and Group Label -->
                <div class="col">
                    <div class="d-flex align-items-center">
                        <button class="btn btn-link p-0 me-2 chevron-button theme-icon" @onclick="ToggleDetails">
                            <img src="/icons/chevron-down.svg" alt="Expand Details"
                                class="chevron-icon @(IsPoolDriveDetailsVisible ? "rotated" : "")"
                                style="height: 24px;" />
                        </button>
                        <!-- Drive Icon -->
                        <img src="/icons/hdd-rack.svg" alt="Drive Icon" style="height: 24px; margin-right: 8px;"
                            class="theme-icon" />
                        <span>@Model.GroupLabel</span>
                    </div>
                </div>
                <!-- Center Section: Size Information and Progress Bar -->
                <div class="col">
                    <div class="text-center mx-4">
                        <div>@FormatSize(Model.Used) / @FormatSize(Model.Size)</div>
                        <Progress Class="mb-0 mt-1" Height="5">
                            <ProgressBar Width="@UsePercentNumeric" />
                        </Progress>
                    </div>
                </div>
                <!-- Right Section: Action Buttons -->
                <div class="col">
                    <Tooltip Title="Remove Pool" Color="TooltipColor.Info">
                        <button class="btn btn-danger" @onclick="RemovePoolGroup">
                            <img src="/icons/trash.svg" alt="Remove Pool" style="height: 24px;" class="theme-icon" />
                        </button>
                    </Tooltip>

                    <Tooltip Title="Rename Pool" Color="TooltipColor.Info">
                        <button class="btn btn-secondary" @onclick="RenamePoolGroup">
                            <img src="/icons/pencil-square.svg" alt="Rename Pool" style="height: 24px;"
                                class="theme-icon" />
                        </button>
                    </Tooltip>

                    <Tooltip Title="Pool Status" Color="TooltipColor.Info">
                        <button class="btn btn-info" @onclick="ShowPoolStatus">
                            <img src="/icons/heart-pulse.svg" alt="Pool Status" style="height: 24px;"
                                class="theme-icon" />
                        </button>
                    </Tooltip>

                    <Tooltip Title="Mount Pool" Color="TooltipColor.Info">
                        @if (!Model.PoolEnabled && Model.AllDrivesConnected)
                        {
                            <button class="btn btn-primary" @onclick="MountPool">
                                <img src="/icons/play.svg" alt="Mount Pool" style="height: 24px;" class="theme-icon" />
                            </button>
                        }
                        else if (!Model.AllDrivesConnected)
                        {
                            <button class="btn btn-primary" disabled>
                                <img src="/icons/play.svg" alt="Connect all drives to mount" style="height: 24px;"
                                    class="theme-icon" />
                            </button>
                        }
                        else
                        {
                            <button class="btn btn-warning" @onclick="UnmountPool">
                                <img src="/icons/eject.svg" alt="Unmount Pool" style="height: 24px;" class="theme-icon" />
                            </button>
                        }
                    </Tooltip>
                </div>
            </div>
        </div>
    </div>

    <!-- Drive Details -->
    @if (IsPoolDriveDetailsVisible)
    {
        <div class="card-body">
            <!-- Drive Details Table -->
            <div class="table-responsive">
                <table class="table table-striped">
                    <tbody>
                        <tr>
                            <th>State</th>
                            <td>@(Model.PoolEnabled ? "Enabled" : "Disabled")</td>
                        </tr>
                        <tr>
                            <th>All Drives Connected</th>
                            <td>@(Model.AllDrivesConnected ? "Yes" : "No")</td>
                        </tr>
                        <tr>
                            <th>Pool Status</th>
                            <td>@Model.PoolStatus</td>
                        </tr>
                        <tr>
                            <th>Size</th>
                            <td>@FormatSize(Model.Size)</td>
                        </tr>
                        <tr>
                            <th>Used</th>
                            <td>@FormatSize(Model.Used)</td>
                        </tr>
                        <tr>
                            <th>Available</th>
                            <td>@FormatSize(Model.Available)</td>
                        </tr>
                        <tr>
                            <th>Use Percent</th>
                            <td>@Model.UsePercent</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pool Drives -->
            @foreach (var drive in Model.Drives)
            {
                <PoolGroupDriveItem @key="drive.Id" Model="@drive" OnForceAdd="@ForceAddDrive" />
            }
        </div>
    }

</div>

<!-- Status Modal -->
<Modal @ref="statusModal" Title="Pool Status">
    <BodyTemplate>
        <pre>@PoolStatusOutput</pre>
    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Secondary" @onclick="CloseStatusModal">Close</Button>
    </FooterTemplate>
</Modal>

@code {
    [Parameter, EditorRequired]
    public PoolGroup Model { get; set; } = default!;

    [Parameter]
    public EventCallback<PoolGroup> OnUnmountPool { get; set; }

    [Parameter]
    public EventCallback<PoolGroup> OnRemovePoolGroup { get; set; }

    [Parameter]
    public EventCallback<PoolGroup> OnMountPool { get; set; }

    [Parameter]
    public EventCallback<PoolGroup> OnRenamePoolGroup { get; set; }

    [Parameter]
    public EventCallback<PoolDrive> OnForceAddDrive { get; set; }

    [Inject]
    protected ToastService ToastService { get; set; } = default!;

    [Inject]
    IDriveService DriveService { get; set; } = default!;

    private bool IsPoolDriveDetailsVisible { get; set; } = false;

    private Modal statusModal = default!;
    private string PoolStatusOutput { get; set; } = string.Empty;

    // Computed property to parse UsePercent string into integer
    private int UsePercentNumeric
    {
        get
        {
            if (int.TryParse(Model.UsePercent.TrimEnd('%'), out int percent))
            {
                // Ensure the percentage is within 0-100
                return Math.Clamp(percent, 0, 100);
            }
            return 0;
        }
    }

    private void ToggleDetails()
    {
        IsPoolDriveDetailsVisible = !IsPoolDriveDetailsVisible;
    }

    private async Task UnmountPool()
    {
        await OnUnmountPool.InvokeAsync(Model);
    }

    private async Task RemovePoolGroup()
    {
        await OnRemovePoolGroup.InvokeAsync(Model);
    }

    private async Task MountPool()
    {
        await OnMountPool.InvokeAsync(Model);
    }

    private async Task RenamePoolGroup()
    {
        await OnRenamePoolGroup.InvokeAsync(Model);
    }

    private async Task ForceAddDrive(PoolDrive drive)
    {
        await OnForceAddDrive.InvokeAsync(drive);
    }

    private async Task ShowPoolStatus()
    {
        var result = await DriveService.GetPoolDetailAsync(Model.PoolGroupGuid);
        if (result.Success)
        {
            PoolStatusOutput = result.Output;
            await statusModal.ShowAsync();
        }
        else
        {
            ToastService.Notify(new ToastMessage(ToastType.Danger, $"Failed to get pool status: {result.Message}"));
        }
    }

    private async Task CloseStatusModal()
    {
        await statusModal.HideAsync();
    }

    private string FormatSize(long sizeInBytes)
    {
        if (sizeInBytes < 1024)
            return $"{sizeInBytes} B";
        else if (sizeInBytes < 1024 * 1024)
            return $"{(sizeInBytes / 1024.0):F2} KB";
        else if (sizeInBytes < 1024 * 1024 * 1024)
            return $"{(sizeInBytes / (1024.0 * 1024.0)):F2} MB";
        else
            return $"{(sizeInBytes / (1024.0 * 1024.0 * 1024.0)):F2} GB";
    }
}
